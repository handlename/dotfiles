---
description: 現在のブランチからPull Requestを作成する
argument-hint: [--base-branch=<branch>] [--draft]
allowed-tools: mcp__acp__Bash(git *), mcp__acp__Bash(gh *), mcp__acp__Read
---

## 前提・背景

現在のブランチから指定ベースブランチへのPull Requestを作成せよ。
GitHub CLI (`gh`) を使用し、コミット履歴から適切なタイトル・説明文を自動生成せよ。

現在のリポジトリ状態:
```
!git status --short --branch
```

## タスク

以下を実行せよ。並行実行可能なタスクは並行実行すること。

**フェーズ1（並行実行可能）:**
- 現在のブランチとリポジトリ状態を確認
- README.mdを読み込み、PRで使用する言語を決定
- ベースブランチを決定し、既存PRの有無を確認
- 設計ドキュメントの有無を確認

**フェーズ2（順次実行）:**
1. リモートへのpush状況を確認し、必要に応じてpush
2. コミット履歴を分析し、変更の意図を把握
3. 設計ドキュメントが存在する場合、その情報を収集
4. PRテンプレート有無を確認し、説明文を生成
5. PRタイトルを生成
6. PR作成内容をユーザーに提示し承認を得る
7. PRを作成し、結果を報告

## オプション

$ARGUMENTS を以下のように分解せよ。

- `--base-branch=<branch>`: ベースブランチ名。未指定時はデフォルトブランチ
- `--draft`: draft PRとして作成

## 完了条件

- PRが正常に作成され、URLを取得できた
- PR内容（タイトル、説明文要約、URL）をユーザーに報告した

## 実行規約

### 使用言語の決定

PRのタイトルと説明文で使用する言語は、リポジトリの`README.md`で使われている言語に合わせよ。

- **README.md存在時**: 内容を読み込み、使用言語を判定
- **README.md非存在時**: 日本語をデフォルトとして使用

### 事前確認

```bash
# 現在のブランチ名
CURRENT_BRANCH=$(git branch --show-current)

# ベースブランチの決定
BASE_BRANCH=${指定値:-$(gh repo view --json defaultBranchRef --jq '.defaultBranchRef.name')}

# 同一ブランチチェック
[ "$CURRENT_BRANCH" = "$BASE_BRANCH" ] && echo "ERROR: 同一ブランチ"

# 既存PR確認
gh pr list --head "$CURRENT_BRANCH" --base "$BASE_BRANCH" --json url,title
```

確認事項:
- 現在のブランチとベースブランチが異なること
- 同一ブランチペアに既存PRが存在しないこと
- unpushedコミット存在時は`git push -u origin HEAD`を提案

### コミット履歴の分析

```bash
# コミット履歴
git log "$BASE_BRANCH..HEAD" --oneline --no-decorate

# 変更ファイル一覧
git diff --name-status "$BASE_BRANCH...HEAD"
```

これらから**変更の意図**を把握せよ。具体的な実装詳細ではなく、なぜこの変更が必要かを理解すること。

### 設計ドキュメントの確認と収集

変更に関連する設計ドキュメントが存在するかを確認せよ。以下の候補を順に探索すること。

**探索対象（優先順）:**
1. リポジトリ内の一般的な設計ドキュメント: `DESIGN.md`, `docs/design/`, `docs/architecture/`
2. 変更対象に対応する設計ドキュメント: 変更ファイルのパスから推測される関連ドキュメント
3. コミットメッセージやIssue内で言及されているドキュメントURL

**ドキュメントが見つかった場合:**
- ドキュメントの種類（オンライン/ローカル）を判定
- オンラインドキュメント: URLを記録
- ローカルファイル: ファイルパスと内容を記録

**ドキュメントが見つからなかった場合:**
- 設計ドキュメントの有無についてユーザーにヒアリングせよ
- ユーザーがURLまたはローカルファイルパスを提供した場合、それを使用

### PR説明文の生成原則

**重要: 差分を読めばわかる実装詳細は記述しない。変更の意図と背景を説明せよ。**

良い説明文の例:
- 「ユーザーからのフィードバックを受け、検索結果の表示速度を改善するため」
- 「セキュリティ監査で指摘された脆弱性に対応するため」

避けるべき説明文の例:
- 「UserService.tsのgetUser関数にキャッシュ処理を追加」
- 「importを整理し、utilsから新しい関数をインポート」

### PRテンプレートの確認と説明文生成

`.github/PULL_REQUEST_TEMPLATE.md`の有無を確認せよ。

**テンプレート存在時:**
- テンプレートを読み込み、各セクションに適切な内容を記述
- チェックリスト項目は`[ ]`形式を維持
- テスト通過に関するチェックリスト項目が存在する場合、チェック済み`[x]`として記述せよ
- 設計ドキュメントが存在する場合、テンプレート内の適切な箇所（関連ドキュメント等のセクション、または末尾）に後述の「設計ドキュメントの記述方法」に従って記載せよ

**テンプレート非存在時:**
以下の構成で説明文を生成せよ。

```markdown
## なぜこの変更が必要か
[変更の動機・背景・解決したい課題]

## どのようなアプローチを取ったか
[選択した解決方針とその理由。代替案があれば、なぜこの方針を選んだか]

## 設計ドキュメント
[設計ドキュメントがある場合のみこのセクションを含める。記述方法は後述]

## レビュー時の注意点
[レビュアーに特に確認してほしい点、議論が必要な設計判断]
```

**設計ドキュメントの記述方法:**

設計ドキュメントが存在する場合、そのドキュメントの種類に応じて以下のように記述せよ。設計ドキュメントが存在しない場合、「設計ドキュメント」セクション自体を省略せよ。

- **オンラインドキュメント（レビュワーが閲覧可能なURL）:**
  リンクとして記載する。

  ```markdown
  ## 設計ドキュメント
  - [設計書タイトルまたはファイル名](URL)
  ```

- **ローカルファイル:**
  `<details><summary>` タグで折りたたんだ状態でファイル内容をPR説明文に直接記載する。

  ```markdown
  ## 設計ドキュメント
  <details>
  <summary>設計書タイトルまたはファイル名（クリックで展開）</summary>

  [ファイルの内容をここにそのまま記載]

  </details>
  ```

- **複数の設計ドキュメントが存在する場合:**
  上記の形式を組み合わせて、すべてのドキュメントを列挙せよ。

**テスト通過に関する記述について:**
関連テストの通過確認はPR作成の前提条件であり、説明文に明記する必要はない。テンプレートにテスト関連のチェックリストが存在する場合のみ、チェック済みとして記載せよ。

### PRタイトルの生成

- コミット数1件: そのコミットメッセージの1行目を使用
- コミット数複数: 最重要のConventional Commits type（feat > fix > refactor > docs > ...）と変更の意図から生成
- 50文字以内、末尾ピリオドなし

### 作成内容の確認

PR作成前に以下をユーザーに提示し承認を得よ。

```
=== Pull Request作成確認 ===
タイトル: [タイトル]
ベースブランチ: [ブランチ名]
Draft PR: [Yes/No]
設計ドキュメント: [あり（種別: オンライン/ローカル）/ なし]

説明文:
---
[説明文]
---

このPRを作成しますか？
```

### PR作成の実行

```bash
gh pr create \
  --title "$TITLE" \
  --body "$BODY" \
  --base "$BASE_BRANCH" \
  $DRAFT_FLAG
```

### 作成結果の報告

```
✓ Pull Requestを作成しました

URL: [PR URL]
タイトル: [タイトル]
ベースブランチ: [ブランチ名]

--- 補足 ---
- レビュアー設定: gh pr edit [URL] --add-reviewer [username]
- ラベル追加: gh pr edit [URL] --add-label [label]
```

## 中断条件

以下の条件を満たした場合は作業を中断し、状況と残タスクを報告せよ。

- 現在のブランチとベースブランチが同一
- 既存PRが同一ブランチペアに存在
- GitHub CLI未インストールまたは認証未完了
- `git push`失敗かつユーザーが再試行を拒否
- ユーザーがPR作成を承認しない

## 禁止事項

- ユーザー確認なしのPR作成
- 差分を読めばわかる実装詳細をPR説明文に記述すること
- PRテンプレート存在時、その構造の無視
- タスクに無関係なファイルの変更
- テスト通過の旨をPR説明文に独立したセクションや項目として記述すること（テンプレートに存在する場合を除く）

## 補足事項

- コミットメッセージから意図が読み取れない場合、変更内容から推測とユーザーへのヒアリングを行え
- 複数Conventional Commits type混在時、影響最大の変更をタイトルに採用せよ
- `gh`コマンドエラー時、`--help`で使用法を確認してから再実行せよ
